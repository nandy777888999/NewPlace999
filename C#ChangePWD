using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using Microsoft.Office.Core;
using Microsoft.Office.Interop.Excel;
using System.IO;
using System.Reflection;
using System.Xml;

namespace WindowsFormsApplication1
{
    public partial class GaiGLMMForm : Form
    {
        public static string[] UserName04 = new string[100];
        public static string[] PassWord04 = new string[100];
        public static string[] Admin04 = new string[100];
        public static string[] AdminPwd04 = new string[100];

        public static int YongHuArreyIndex04;
        public static int GuanLiyuanArreyIndex04;

        public static int NewUserNameIndex04;//新用户元素值
        public static int NewAdminNameIndex04;//新用户元素值

        public String YuanMiMa;//用来记录原密码
        public  int Index;//用来记录改密管理员数组下边
        public GaiGLMMForm()
        {
            InitializeComponent();
            ReadXMLConfigFile_INIT();
            this.ControlBox = false;
            label4.Text = MainLoginForm.NOWAdminName[MainLoginForm.GuanLiyuanArreyIndex];//参数全部来自MainLoginForm
            NewAdminNameIndex04 = MainLoginForm.GuanLiyuanArreyIndex;
        }

        private void button1_Click(object sender, EventArgs e) //确认按钮
        {

            string label4text = textBox1.Text;
            string label3 = (label4.Text).ToString();
            string label2 = (UserName04[MainLoginForm.GuanLiyuanArreyIndex]).ToString();
            int label4textLength = label4text.Length;
           
            for(int i=0;i< NewAdminNameIndex04+1;i++)
            {
                if (label4.Text == Admin04[i])
                {
                    Index = i;
                    YuanMiMa = AdminPwd04[i];
                    break;
                }
                    
            }

           if ((label4textLength >1)&& (textBox3.Text == YuanMiMa) &&(textBox1.Text== textBox2.Text))
            {
                AdminPwd04[Index] = textBox1.Text;
                Admin04[Index] = label4.Text;
                MainLoginForm.AdminPwd[Index] = AdminPwd04[Index];
                MainLoginForm.Admin[Index] = label4.Text;
                CreatXMLConfigFile_04();
            }
           else
            {
                if(label4textLength < 1)
                {
                    MessageBox.Show("新密码输入为空，请重新输入新密码(位数大于1)！！");
                }
              
                if (textBox1.Text != textBox2.Text)
                {

                        MessageBox.Show("新密码两次输入不一致！请重新输入新密码(位数大于1)！！");

                 }
                  if(textBox3.Text != AdminPwd04[MainLoginForm.GuanLiyuanArreyIndex])
                 {

                        MessageBox.Show("密码错误！！！"+ AdminPwd04[MainLoginForm.GuanLiyuanArreyIndex]+ textBox3.Text+ textBox1.Text);

                  }           
            }
            this.Close();
            

        }

        private void GaiGLMMForm_Load(object sender, EventArgs e)
        {
          
        }

        private void button2_Click(object sender, EventArgs e)//取消按钮
        {
            this.Close();
        }

        private void ReadXMLConfigFile_INIT()//创建系统XML配置文件
        {
            if (true)//判断
            {
                XmlDocument doc = new XmlDocument();
                doc.Load(MainLoginForm.SysConfigPath00);    //加载Xml文件,全路径  
                XmlElement rootNodes = doc.DocumentElement;   //获取根节点  

                /*----------------------------读取IndexValue-----------------------*/
                XmlNodeList PointNodes = rootNodes.GetElementsByTagName("IndexValue"); //获取节点名字
                foreach (XmlNode node in PointNodes)
                {
                    string ArreyIndex = ((XmlElement)node).GetAttribute("Value");   //获取UserName属性值
                    NewUserNameIndex04 = int.Parse(ArreyIndex);
                }
                MessageBox.Show("NewUserNameIndex06读取完成！请继续操作！！" + NewUserNameIndex04);


                /*----------------------------读取NewUserName-----------------------*/
                for (int i = 0; i < NewUserNameIndex04 + 1; i++)
                {
                    XmlNodeList PointNodes02 = rootNodes.GetElementsByTagName("USER" + i); //获取节点名字
                    foreach (XmlNode node in PointNodes02)
                    {
                        UserName04[i] = ((XmlElement)node).GetAttribute("UserName");   //获取UserName属性值
                        PassWord04[i] = ((XmlElement)node).GetAttribute("PassWord");   //获取UserName属性值
                    }

                }

                MessageBox.Show("UserName读取完成！请继续操作！！" + NewUserNameIndex04);


                /*----------------------------读取NewAdminNameIndex06-----------------------*/


                XmlNodeList PointNodes12 = rootNodes.GetElementsByTagName("AdminIndexValue"); //获取节点名字
                foreach (XmlNode node in PointNodes12)
                {
                    string ArreyIndex12 = ((XmlElement)node).GetAttribute("AdminValue");   //获取UserName属性值

                    NewAdminNameIndex04 = int.Parse(ArreyIndex12);

                }

                MessageBox.Show("NewAdminNameIndex06读取完成！请继续操作！！" + NewUserNameIndex04);

                /*----------------------------读取NewAdminName-----------------------*/

                for (int i = 0; i < NewAdminNameIndex04 + 1; i++)
                {
                    XmlNodeList PointNodes02 = rootNodes.GetElementsByTagName("Admin" + i); //获取节点名字
                    foreach (XmlNode node in PointNodes02)
                    {
                        Admin04[i] = ((XmlElement)node).GetAttribute("Admin");   //获取UserName属性值
                        AdminPwd04[i] = ((XmlElement)node).GetAttribute("AdminPwd");   //获取UserName属性值
                    }

                }

                MessageBox.Show("UserName读取完成！请继续操作！！" + Admin04[0]);
            }
        }

        private void CreatXMLConfigFile_04()//创建系统XML配置文件
        {
            XmlDocument xmldoc;
            XmlElement xmlelem;
            xmldoc = new XmlDocument();//声明xml格式的 xmldoc文件
            //加入XML的声明段落,<?xml version="1.0" encoding="gb2312"?>
            XmlDeclaration xmldecl;
            xmldecl = xmldoc.CreateXmlDeclaration("1.0", "gb2312", null);
            xmldoc.AppendChild(xmldecl);
            //加入一个根元素
            xmlelem = xmldoc.CreateElement("", "Employees", "");
            xmldoc.AppendChild(xmlelem);

            //加入另外一个元素
            /*-----------------------------写入UserName--------------------------*/
            XmlNode root01 = xmldoc.SelectSingleNode("Employees");//查找<Employees>


            for (int i = 0; i < NewUserNameIndex04 + 1; i++)     //范围增一
            {
                XmlElement xe12 = xmldoc.CreateElement("USER" + i);//创建一个<Node>节点
                xe12.SetAttribute("UserName", UserName04[i]);//设置该节点genre属性
                xe12.SetAttribute("PassWord", PassWord04[i]);//设置该节点ISBN属性
                root01.AppendChild(xe12);//添加到<Employees>节点中
            }

            /*-----------------------------写入IndexValue--------------------------*/

            XmlNode root = xmldoc.SelectSingleNode("Employees");//查找<Employees>
            XmlElement xe1 = xmldoc.CreateElement("IndexValue");//创建一个<Node>节点

            xe1.SetAttribute("Value", NewUserNameIndex04.ToString());//设置该节点Value通过ArreyIndexValue01.ToString()赋值0属性
            root.AppendChild(xe1);//添加到<Employees>节点中


            /*-----------------------------写入AdminName--------------------------*/
            XmlNode root02 = xmldoc.SelectSingleNode("Employees");//查找<Employees>


            for (int i = 0; i < NewAdminNameIndex04 + 1; i++)     //范围增一
            {
                XmlElement xe31 = xmldoc.CreateElement("Admin" + i);//创建一个<Node>节点
                xe31.SetAttribute("Admin", Admin04[i]);//设置该节点genre属性
                xe31.SetAttribute("AdminPwd", AdminPwd04[i]);//设置该节点ISBN属性
                root01.AppendChild(xe31);//添加到<Employees>节点中
            }

            /*-----------------------------写入IndexValue--------------------------*/

            XmlNode root03 = xmldoc.SelectSingleNode("Employees");//查找<Employees>
            XmlElement xe33 = xmldoc.CreateElement("AdminIndexValue");//创建一个<Node>节点
            xe33.SetAttribute("AdminValue", NewAdminNameIndex04.ToString());//设置该节点Value通过ArreyIndexValue01.ToString()赋值0属性
            root.AppendChild(xe33);//添加到<Employees>节点中

            /*-----------------------------保存--------------------------*/
            xmldoc.Save(MainLoginForm.SysConfigPath00);
            MessageBox.Show("密码修改成功！");
            //  MessageBox.Show("UserName读取完成！请继续操作！！" + Admin04[0]+ "/"+AdminPwd04[0]);//测试用，其他时间无用
        }


    }




}

 
